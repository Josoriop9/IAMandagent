name: Smoke Tests (post-deploy)

# Railway auto-deploys when you push to main or staging.
# This workflow waits, then runs smoke tests to confirm the deploy is healthy.

on:
  push:
    branches:
      - main     # â†’ Production
      - staging  # â†’ Staging

# Only one test run at a time per environment
concurrency:
  group: smoke-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  smoke-test:
    name: Smoke test â€” ${{ github.ref_name }}
    runs-on: ubuntu-latest

    steps:
      - name: Set target URL
        id: env
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "url=https://iamandagent-production.up.railway.app" >> $GITHUB_OUTPUT
            echo "name=PRODUCTION" >> $GITHUB_OUTPUT
          else
            echo "url=https://iamandagent-production.up.railway.app" >> $GITHUB_OUTPUT
            echo "name=STAGING" >> $GITHUB_OUTPUT
          fi

      - name: Wait for Railway to finish deploying
        run: |
          echo "â³ Waiting 45s for Railway to deploy commit ${{ github.sha }}..."
          sleep 45

      - name: Health check
        run: |
          URL="${{ steps.env.outputs.url }}"
          ENV="${{ steps.env.outputs.name }}"
          echo "ðŸ” Running smoke tests against $ENV ($URL)..."

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 "$URL/health")
          if [ "$STATUS" != "200" ]; then
            echo "âŒ /health returned HTTP $STATUS (expected 200)"
            exit 1
          fi
          echo "âœ… /health â†’ $STATUS"

      - name: Auth endpoint check
        run: |
          URL="${{ steps.env.outputs.url }}"

          # /v1/agents without API key should return 422 (missing header) or 401
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 "$URL/v1/agents")
          if [ "$STATUS" = "200" ]; then
            echo "âŒ /v1/agents returned 200 without auth (security issue!)"
            exit 1
          fi
          echo "âœ… /v1/agents auth check â†’ $STATUS (unauthenticated correctly rejected)"

      - name: All smoke tests passed
        run: |
          echo "ðŸŽ‰ ${{ steps.env.outputs.name }} is healthy â€” commit ${{ github.sha }}"

  # Auto-publish to PyPI when version changes on main
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: smoke-test
    if: github.ref_name == 'main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if version changed
        id: version_check
        run: |
          CURRENT=$(grep '^version' pyproject.toml | head -1 | cut -d'"' -f2)
          PREVIOUS=$(git show HEAD~1:pyproject.toml | grep '^version' | head -1 | cut -d'"' -f2 || echo "")
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "previous=$PREVIOUS" >> $GITHUB_OUTPUT
          if [ "$CURRENT" != "$PREVIOUS" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Version changed: $PREVIOUS â†’ $CURRENT â€” will publish to PyPI"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Version unchanged ($CURRENT) â€” skipping PyPI publish"
          fi

      - name: Set up Python
        if: steps.version_check.outputs.changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build and publish to PyPI
        if: steps.version_check.outputs.changed == 'true'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          pip install build twine
          python -m build
          twine upload dist/*
          echo "âœ… Published hashed-sdk v${{ steps.version_check.outputs.current }} to PyPI"

      - name: Create GitHub Release
        if: steps.version_check.outputs.changed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.version_check.outputs.current }}"
          name: "v${{ steps.version_check.outputs.current }}"
          generate_release_notes: true
          draft: false
