name: Deploy

on:
  push:
    branches:
      - main     # â†’ Production
      - staging  # â†’ Staging

# Only one deploy at a time per environment
concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Railway (${{ github.ref_name }})
    runs-on: ubuntu-latest

    # Map branch â†’ environment label
    environment:
      name: ${{ github.ref_name == 'main' && 'production' || 'staging' }}
      url: ${{ github.ref_name == 'main' && 'https://api.hashed.dev' || 'https://staging.api.hashed.dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          # Select service based on branch
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "ðŸš€ Deploying to PRODUCTION..."
            railway up \
              --service hashed-api-prod \
              --detach
          else
            echo "ðŸ”§ Deploying to STAGING..."
            railway up \
              --service hashed-api-staging \
              --detach
          fi

      - name: Wait for deployment
        run: sleep 30

      - name: Smoke test â€” Health check
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            URL="https://api.hashed.dev"
          else
            URL="https://staging.api.hashed.dev"
          fi

          echo "Running smoke tests against $URL..."

          # Health check
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL/health")
          if [ "$STATUS" != "200" ]; then
            echo "âŒ Health check failed: HTTP $STATUS"
            exit 1
          fi
          echo "âœ… /health â†’ $STATUS"

          # Auth endpoint reachable (401 expected without key)
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL/v1/agents")
          if [ "$STATUS" != "401" ] && [ "$STATUS" != "403" ]; then
            echo "âŒ /v1/agents returned unexpected status: HTTP $STATUS"
            exit 1
          fi
          echo "âœ… /v1/agents auth check â†’ $STATUS (expected 401/403)"

          echo ""
          echo "ðŸŽ‰ Smoke tests passed for $URL"

      - name: Notify success
        if: success()
        run: |
          ENV=${{ github.ref_name == 'main' && 'PRODUCTION' || 'STAGING' }}
          echo "âœ… Deploy to $ENV complete â€” commit ${{ github.sha }}"

      - name: Notify failure
        if: failure()
        run: |
          ENV=${{ github.ref_name == 'main' && 'PRODUCTION' || 'STAGING' }}
          echo "âŒ Deploy to $ENV FAILED â€” commit ${{ github.sha }}"
          echo "Check Railway dashboard for logs."

  # Auto-publish to PyPI when version changes on main
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref_name == 'main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if version changed
        id: version_check
        run: |
          # Compare pyproject.toml version between this and previous commit
          CURRENT=$(grep '^version' pyproject.toml | head -1 | cut -d'"' -f2)
          PREVIOUS=$(git show HEAD~1:pyproject.toml | grep '^version' | head -1 | cut -d'"' -f2 || echo "")
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "previous=$PREVIOUS" >> $GITHUB_OUTPUT
          if [ "$CURRENT" != "$PREVIOUS" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Version changed: $PREVIOUS â†’ $CURRENT"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Version unchanged ($CURRENT), skipping PyPI publish"
          fi

      - name: Set up Python
        if: steps.version_check.outputs.changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build package
        if: steps.version_check.outputs.changed == 'true'
        run: |
          pip install build twine
          python -m build

      - name: Publish to PyPI
        if: steps.version_check.outputs.changed == 'true'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          twine upload dist/*
          echo "âœ… Published hashed-sdk v${{ steps.version_check.outputs.current }} to PyPI"

      - name: Create GitHub Release
        if: steps.version_check.outputs.changed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.version_check.outputs.current }}"
          name: "v${{ steps.version_check.outputs.current }}"
          generate_release_notes: true
          draft: false
